Step 1: 
  Install UM2 using the instructions at:
  https://univeristy-of-michigan-unstructured-mesh-code.readthedocs.io/en/main/install.html

If building serial, see steps 2A and 3A. If building with MPI, see steps 2B and 3B.

Step 2A:
  MPACT needs to be built with gcc@8, but linked with gcc@12 due to UM2's use of C++20.
  Using build_with_hdf5.sh, build_with_um2.sh, and a serial build script from the /build_scripts/
  directory, enter the following commands to install gcc@8 and build MPACT:
    despacktivate
    spack install gcc@8
    spack load gcc@8
    spack compiler find
    SPACK_VIEW_DIR=${SPACK_ENV}/.spack-env/view
    spacktivate -p um2
    cd MPACT && mkdir build && cd build
    HDF5_ROOT=$SPACK_VIEW_DIR UM2_ROOT=<path/to/um2/build> ./build_with_hdf5.sh ./build_with_um2.sh <serial_build_script> ..
    make -j MPACT

  The final linking of MPACT will fail, but that is expected.

Step 3A:
  In the final link step, instead of gcc@8 we will use gcc@12. Enter the following commands:
    despacktivate
    spack load gcc@12 <-- Installed during UM2 build
    GFORTRAN12=$(which gfortran)
    spacktivate -p um2
    cd MPACT_exe/src
    make VERBOSE=1 MPACT

  This will fail, but list the command used for linking MPACT. Copy this command and simply replace
  the path to gcc@8 with $GFORTRAN12. It should look something like this:
    $GFORTRAN12 -cpp -fall-intrinsics -ffree-line-length-none -std=f2008 -DMPACT_HAVE_HDF5 -DFUTILITY_HAVE_HDF5 -DFUTILITY_DBC -DUNIT_TEST -DDBL -g -O0 -Og -Wall -Wextra -Wno-maybe-uninitialized -Wno-surprising -fcheck=all -fbacktrace CMakeFiles/MPACT.dir/MPACT.f90.o -o MPACT.exe  -Wl,-rpath,/home/kcvaughn/work/spack/var/spack/environments/um2_user/.spack-env/view/lib:/home/kcvaughn/work/UM2/build/lib:::::::::::::::::::::::::::::::::::::::::::: ../../MPACT_Drivers/src/libDriver.a ../../MPACT_libs/UI/src/libUI.a ../../MPACT_libs/Factories/src/libFactories.a ../../MPACT_libs/PostOps/src/libPostOps.a ../../MPACT_libs/IsotopeAdjust/src/libIsotopeAdjust.a ../../MPACT_libs/Transient/src/libTransient.a ../../MPACT_libs/Depletion/src/libDepletion.a ../../MPACT_libs/MassTransport/src/libMassTransport.a ../../MPACT_libs/Feedback/src/libFeedback.a ../../MPACT_libs/Coupler/src/libCoupler.a ../../MPACT_libs/Coupler/src/libMPIKE.a ../../MPACT_libs/EditsVariables/src/libEditsVariables.a ../../MPACT_libs/CMFD/src/libCMFD.a ../../MPACT_libs/PlanarSynthesis/src/libPlanarSynthesis.a ../../MPACT_libs/Nodal/src/libNodal.a ../../MPACT_libs/Sn/src/libSn.a ../../MPACT_libs/MOC/src/libMOC.a ../../MPACT_libs/CoreSolvers/src/libCoreSolvers.a ../../MPACT_libs/XS/src/libXS.a ../../MPACT_libs/Reactor/src/libReactor.a ../../MPACT_libs/Reactor/src/libReactorBase.a ../../MPACT_libs/ThermalExpandXML/src/libTEXML.a ../../MPACT_libs/MPACTUtils/src/libMPACTUtils.a ../../Futility/src/libUtils.a ../../Futility/src/fmu_interfaces/libFmuUtils.a ../../Futility/src/trilinos_interfaces/libTrilinosUtils.a ../../Futility/src/libCUtils.a /home/kcvaughn/work/spack/var/spack/environments/um2_user/.spack-env/view/lib/libhdf5.so /home/kcvaughn/work/spack/var/spack/environments/um2_user/.spack-env/view/lib/libhdf5_cpp.so /home/kcvaughn/work/spack/var/spack/environments/um2_user/.spack-env/view/lib/libhdf5_fortran.so -ldl -lstdc++

Step 2B:
  MPACT needs to be built with mpich@3.3%gcc@8, but linked with mpich@3.3%gcc@12 due to 
  UM2's use of C++20.
  Using build_with_hdf5.sh, build_with_um2.sh, and an MPI build script from the /build_scripts/
  directory, enter the following commands to install the necessary compilers and build MPACT:
    despacktivate
    spack load gcc@12 <-- Installed during UM2 build
    spack install mpich@3.3%gcc@12
    spack compiler find
    spack install gcc@8
    spack load gcc@8
    spack compiler find
    spack install mpich@3.3%gcc@8
    spack load mpich@3.3%gcc@8
    spack compiler find
    SPACK_VIEW_DIR=${SPACK_ENV}/.spack-env/view
    spacktivate -p um2
    cd MPACT && mkdir build && cd build
    HDF5_ROOT=$SPACK_VIEW_DIR UM2_ROOT=<path/to/um2/build> ./build_with_hdf5.sh ./build_with_um2.sh <mpi_build_script> ..
    make -j MPACT

Step 3B:    
  In the final link step, instead of mpich@3.3%gcc@8 we will use mpich@3.3%gcc@12. 
  Enter the following commands:    
    despacktivate    
    spack load gcc@12
    spack load mpich3.3@gcc@12 
    MPIF90=$(which mpif90)
    spacktivate -p um2    
    cd MPACT_exe/src    
    make VERBOSE=1 MPACT 

  This will fail, but list the command used for linking MPACT. Copy this command and simply replace
  the path to mpif90 with $MPIF90. It should look something like this:
    $MPIF90 -cpp -fall-intrinsics -ffree-line-length-none -DHAVE_MPI -DMPACT_HAVE_HDF5 -DFUTILITY_HAVE_HDF5 -DHAVE_MPI -DFUTILITY_DBC -DUNIT_TEST -DDBL -g -O0 -Og -Wall -Wextra -Wno-maybe-uninitialized -Wno-surprising -fcheck=all -fbacktrace CMakeFiles/MPACT.dir/MPACT.f90.o -o MPACT.exe  -Wl,-rpath,/home/kcvaughn/work/spack/var/spack/environments/um2_user/.spack-env/view/lib:/home/kcvaughn/work/UM2/build/lib:::::::::::::::::::::::::::::::::::::::::::: ../../MPACT_Drivers/src/libDriver.a ../../MPACT_libs/UI/src/libUI.a ../../MPACT_libs/Factories/src/libFactories.a ../../MPACT_libs/PostOps/src/libPostOps.a ../../MPACT_libs/IsotopeAdjust/src/libIsotopeAdjust.a ../../MPACT_libs/Transient/src/libTransient.a ../../MPACT_libs/Depletion/src/libDepletion.a ../../MPACT_libs/MassTransport/src/libMassTransport.a ../../MPACT_libs/Feedback/src/libFeedback.a ../../MPACT_libs/Coupler/src/libCoupler.a ../../MPACT_libs/Coupler/src/libMPIKE.a ../../MPACT_libs/EditsVariables/src/libEditsVariables.a ../../MPACT_libs/CMFD/src/libCMFD.a ../../MPACT_libs/PlanarSynthesis/src/libPlanarSynthesis.a ../../MPACT_libs/Nodal/src/libNodal.a ../../MPACT_libs/Sn/src/libSn.a ../../MPACT_libs/MOC/src/libMOC.a ../../MPACT_libs/CoreSolvers/src/libCoreSolvers.a ../../MPACT_libs/XS/src/libXS.a ../../MPACT_libs/Reactor/src/libReactor.a ../../MPACT_libs/Reactor/src/libReactorBase.a ../../MPACT_libs/ThermalExpandXML/src/libTEXML.a ../../MPACT_libs/MPACTUtils/src/libMPACTUtils.a ../../Futility/src/libUtils.a ../../Futility/src/fmu_interfaces/libFmuUtils.a ../../Futility/src/trilinos_interfaces/libTrilinosUtils.a ../../Futility/src/libCUtils.a /home/kcvaughn/work/spack/var/spack/environments/um2_user/.spack-env/view/lib/libhdf5.so /home/kcvaughn/work/spack/var/spack/environments/um2_user/.spack-env/view/lib/libhdf5_cpp.so /home/kcvaughn/work/spack/var/spack/environments/um2_user/.spack-env/view/lib/libhdf5_fortran.so -ldl /home/kcvaughn/work/UM2/build/lib/libum2.so -lmpicxx -lstdc++


Step 4:
  Test the installation. UM2 hasn't been integrated into MPACT's main yet, so /MPACT/1a/ still 
  exists on the UM2 branch from old testing. We can use this to test the installation.
    cd MPACT/1a/um2_real
    ln -s ../../MPACT_Extras/xslibs/mpact51g_71_v4.2m5_12062016_sph.fmt mpact51g_71_v4.2m5_12062016_sph.fmt
    <modify runjob.sh to use the location of your MPACT.exe>
    ./runjob.sh

Final notes:
  You need to load mpich in order to use mpirun and parallel MPACT.
