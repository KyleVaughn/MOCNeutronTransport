name: CI 

on: [push]

jobs:
  main:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: true
      matrix:
        compiler: [ gcc, clang ]
        build_type: [ Release, Debug ]
        cuda: [ OFF ]
        openmp: [ OFF, ON ]
        vis: [OFF]
        dev_mode: [ OFF, ON ]

    name: "${{ matrix.compiler }}, ${{ matrix.build_type }}, OMP=${{ matrix.openmp }}, 
      Vis=${{ matrix.vis }}, Dev=${{ matrix.dev_mode }}"

    steps:
      - uses: actions/checkout@v3

      - name: Set up gcc 
        shell: bash
        if: matrix.compiler == 'gcc'
        run: |
          sudo apt -y update
          sudo apt install -y gcc-12 g++-12 clang-14
          echo "CC=gcc-12" >> $GITHUB_ENV 
          echo "CXX=g++-12" >> $GITHUB_ENV 

      - name: Set up clang 
        shell: bash
        if: matrix.compiler == 'clang' 
        run: |
          sudo apt -y update
          sudo apt install -y clang-14
          echo "CC=clang-14" >> $GITHUB_ENV 
          echo "CXX=clang++-14" >> $GITHUB_ENV 

      - name: OpenMP
        shell: bash
        if: matrix.openmp == 'ON'
        run: sudo apt install -y libomp-14-dev

      - name: Vis
        shell: bash
        if: matrix.vis == 'ON'
        run: sudo apt install -y xorg-dev libgl1-mesa-dev

      - name: Dev mode dependencies
        shell: bash
        if: matrix.dev_mode == 'ON'
        run: |
          sudo apt install -y cppcheck

      - name: Configure and build
        run: |
          cmake -S . -B build \
                -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                -DUM2_ENABLE_CUDA=${{ matrix.cuda }} \
                -DUM2_ENABLE_OPENMP=${{ matrix.openmp }} \
                -DUM2_DEV_MODE=${{ matrix.dev_mode }}
          make -j -C build

      - name: Format check
        if: matrix.dev_mode == 'ON'
        run: make -C build format-check

      - name: Run tests
        run: 
          make -j -C build test 
